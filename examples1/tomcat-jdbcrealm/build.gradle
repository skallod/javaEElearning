/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */
apply plugin: 'war'

group = 'ru.galuzin'
version = '1'
description = """tomcat jdbc realm"""
sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    // https://mvnrepository.com/artifact/javax.servlet/javax.servlet-api
    providedCompile group: 'javax.servlet', name: 'javax.servlet-api', version: '3.0.1'
}

task wrapper(type: Wrapper) {
    gradleVersion = '4.7'
}

//------------ deploy block -----------
project.ext {
    tomcatDir="c:\\Dev\\Distr\\tomcat\\tomcat8_5"
    appWarName="tomcat-jdbcrealm-1.war"
}
task deleteDeployed(type: Delete) {
    println("tom dir ${tomcatDir}")
    delete "${tomcatDir}\\webapps\\ROOT.war", "${tomcatDir}\\webapps\\ROOT"
}
task renameROOT(type: Copy, group: "Custom", description: "Copies sources to the dest directory") {
    from("build/libs")
    into("build/libs")
    include("${appWarName}")
    rename("${appWarName}","ROOT.war")
}
task deploy(type:Copy){
    from("build/libs")
    into("${tomcatDir}\\webapps")
    include("ROOT.war")
}
task restartTom(type: Exec) {
    workingDir "${tomcatDir}\\bin"
    println("test $workingDir")
    commandLine 'cmd', '/c', 'shutdown.bat'
    doLast {
        ProcessBuilder pb = new ProcessBuilder("cmd", "/c", "startup.bat")
        pb.directory(new File("$workingDir"))
        pb.start();
    }
}

deleteDeployed.dependsOn build
renameROOT.dependsOn deleteDeployed
deploy.dependsOn renameROOT
restartTom.dependsOn deploy
